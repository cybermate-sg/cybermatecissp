/* eslint-env node */
const { Client } = require('pg');
const fs = require('fs');
const path = require('path');
require('dotenv').config({ path: '.env.local' });

async function applyMigration() {
    const client = new Client({
        connectionString: process.env.POSTGRES_URL || process.env.DATABASE_URL
    });

    try {
        await client.connect();
        console.log('✓ Connected to Xata\n');

        // Security: Validate migration file path
        // This script executes SQL from trusted Drizzle migration files.
        // The file path is hardcoded and validated to ensure it's in the migrations directory.
        const migrationFileName = '0000_secret_nightcrawler.sql';
        const basePath = path.resolve(__dirname, 'drizzle', 'migrations');

        // Use path.normalize to resolve any '..' or '.' in the path
        const joinedPath = path.join(basePath, migrationFileName);
        const normalizedPath = path.normalize(joinedPath);

        // Validate that the normalized path is contained within our basePath
        if (!normalizedPath.startsWith(basePath)) {
            throw new Error('Security: Migration file must be in the migrations directory');
        }

        // Justification: Path is validated above to be within the migrations directory
        // nosemgrep: codacy.tools-configs.javascript_pathtraversal_rule-non-literal-fs-filename
        if (!fs.existsSync(normalizedPath)) {
            throw new Error(`Migration file not found: ${migrationFileName}`);
        }

        // Justification: Path is validated above to be within the migrations directory
        // nosemgrep: codacy.tools-configs.javascript_pathtraversal_rule-non-literal-fs-filename
        const migrationSQL = fs.readFileSync(normalizedPath, 'utf8');

        console.log('Applying migration 0000_secret_nightcrawler.sql...\n');

        // Justification: SQL statements are read from a trusted, validated migration file
        // generated by Drizzle ORM. This is not user input and poses no SQL injection risk.
        // The migration file is hardcoded and path-validated above.
        // nosemgrep: codacy.tools-configs.rules_lgpl_javascript_database_rule-node-sqli-injection
        const statements = migrationSQL
            .split('-->statement-breakpoint')
            .map(s => s.trim())
            .filter(s => s.length > 0);

        console.log(`Found ${statements.length} statements to execute\n`);

        let successCount = 0;
        let skipCount = 0;
        let errorCount = 0;

        // Justification: Sequential execution required for database migrations to maintain
        // proper dependency order between statements (tables, indexes, foreign keys, etc.).
        // SQL content is from trusted Drizzle ORM migration files, not user input.
        // nosemgrep: codacy.tools-configs.rules_lgpl_javascript_database_rule-node-sqli-injection
        for (let i = 0; i < statements.length; i++) {
            const statement = statements[i];

            // Skip comments
            if (statement.startsWith('--') || statement.startsWith('/*')) {
                continue;
            }

            try {
                // Execute trusted migration SQL statement
                await client.query(statement);
                successCount++;

                // Log progress for major operations
                if (statement.includes('CREATE TYPE')) {
                    const match = statement.match(/CREATE TYPE "public"\."(\w+)"/);
                    if (match) console.log(`  ✓ Created enum: ${match[1]}`);
                } else if (statement.includes('CREATE TABLE')) {
                    const match = statement.match(/CREATE TABLE "(\w+)"/);
                    if (match) console.log(`  ✓ Created table: ${match[1]}`);
                } else if (statement.includes('CREATE INDEX')) {
                    const match = statement.match(/CREATE INDEX "(\w+)"/);
                    if (match) console.log(`  ✓ Created index: ${match[1]}`);
                }
            } catch (error) {
                // Check if it's a "already exists" error (42P07 for tables, 42710 for types, etc.)
                if (error.code === '42P07' || error.code === '42710' || error.code === '42P16') {
                    skipCount++;
                    // Silently skip - object already exists
                } else {
                    errorCount++;
                    // Use separate arguments to avoid format string injection
                    console.log('  ✗ Error in statement', i + 1 + ':', error.message);
                }
            }
        }

        console.log(`\n=== Migration Summary ===`);
        console.log(`  ✓ Executed: ${successCount}`);
        console.log(`  ⊘ Skipped (already exists): ${skipCount}`);
        console.log(`  ✗ Errors: ${errorCount}`);

        if (errorCount === 0) {
            console.log('\n✅ Migration applied successfully!');
            process.exit(0);
        } else {
            console.log('\n⚠️  Migration completed with some errors');
            process.exit(1);
        }

    } catch (error) {
        console.error('\n❌ Fatal error:', error.message);
        process.exit(1);
    } finally {
        await client.end();
    }
}

applyMigration();
